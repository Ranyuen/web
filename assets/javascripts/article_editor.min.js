!function(a){function b(b){return a.setImmediate?a.setImmediate(b):a.requestAnimationFrame?a.requestAnimationFrame(b):setTimeout(b,0)}function c(a,c){var d=!1,e=!1;return c||(d=!0),(!c||0>=c)&&(c=1e3/30),function(){e||(e=!0,a.apply(this,arguments),d?b(function(){e=!1}):setTimeout(function(){e=!1},c))}}function d(a){return document.importNode(document.getElementById(a).content,!0).firstElementChild}function e(a,b){var c=this;e=function(){return this},b=b||new g,this.article=null,this.currentContent=null,this.langTabItems=[],this.node=a,this.nodePathInput=a.querySelector(".articleEditor_path_input"),this.nodeLangTab=a.querySelector(".articleEditor_langTab"),this.nodeLangTabPlus=a.querySelector(".articleEditor_langTab_plus"),this.nodeContentInput=a.querySelector(".articleEditor_content_input"),this.nodeContentPreview=a.querySelector(".articleEditor_content_preview"),this.nodeErrors=a.querySelector(".articleEditor_errors"),this.nodeSave=a.querySelector(".articleEditor_save"),EventRouter.on("selectLangTabItem",function(a,b){c.switchContent(a,b)}),EventRouter.on("changeLangTabItemLang",function(a,b){b.lang=a.nodeLang.textContent}),EventRouter.on("removeLangTabItem",function(a,b){c.removeContent(a,b)}),this.nodePathInput.addEventListener("keyup",function(){c.article.path=c.nodePathInput.value}),this.nodeLangTabPlus.addEventListener("click",function(){c.createContent()}),this.nodeContentInput.addEventListener("keyup",function(){c.currentContent.content=c.nodeContentInput.value}),this.nodeSave.addEventListener("click",function(){c.save()}),this.attachArticle(b)}function f(a){var b=this;this.content=a,this.isSelected=!1,this.node=d("articleEditor_langTab_item"),this.nodeLang=this.node.querySelector(".articleEditor_langTab_item_lang"),this.nodeRemove=this.node.querySelector(".articleEditor_langTab_item_remove"),this.nodeLang.textContent=a.lang||"-",this.nodeLang.addEventListener("click",function(){EventRouter.emit("selectLangTabItem",[b,b.content])}),this.nodeLang.addEventListener("keyup",function(){EventRouter.emit("changeLangTabItemLang",[b,a])}),this.nodeRemove.addEventListener("click",function(){EventRouter.emit("removeLangTabItem",[b,a])})}function g(){var a;this.id=0,this.path="",this.contents=[],this.errors=[],a=new h,a.lang="ja",this.contents.push(a),a=new h,a.lang="en",this.contents.push(a)}function h(){this.lang="",this.content="---\ntitle: 題\ndescription: 説明\n---\n{{ title }}\n==\n本文。",this.errors=[]}function i(a){this.name=i.name,this.messages=a,this.stack=Error().stack}function j(a){var b;this.name=j.name,b=(a.responseText||this.name)+" HTTP status: "+a.status,this.message=b,this.stack=Error().stack}Array.from||(Array.from=function(a){return[].slice.call(a)}),String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(a,b){return b=b||0,this.lastIndexOf(a,b)===b}}),EventRouter={listeners:{},emit:function(a,b,c){b=b||[],c=c||null,this.listeners[a].forEach(function(a){a.apply(c,b)})},on:function(a,b){this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].push(b)}},e.prototype.run=function(){var a=this,b="";requestAnimationFrame(function c(){b!==a.currentContent.content&&(b=a.currentContent.content,a.preview()),requestAnimationFrame(c)})},e.prototype.switchContent=function(a,b){this.currentContent=b,this.langTabItems.forEach(function(a){a.unselect()}),a.select(),this.nodeContentInput.value=this.currentContent.content,this.preview()},e.prototype.createContent=function(a){var b;a||(a=new h,this.article.contents.push(a)),b=new f(a),this.langTabItems.push(b),this.nodeLangTab.insertBefore(b.node,this.nodeLangTabPlus),this.switchContent(b,a)},e.prototype.removeContent=function(a,b){var c,d=0,e=0;if(window.confirm(b.lang+" を削除するか?")){for(d=0,e=this.article.contents.length;e>d;++d)if(b===this.article.contents[d]){this.article.contents.splice(d,1);break}for(d=0,e=this.langTabItems.length;e>d;++d)if(a===this.langTabItems[d]){this.langTabItems.splice(d,1);break}a.node.classList.contains("articleEditor_langTab_item-selected")&&(0===this.langTabItems.length?(this.createContent(),c=this.langTabItems[0]):c=0===d?this.langTabItems[0]:this.langTabItems[d-1],this.switchContent(c,c.content)),this.nodeLangTab.removeChild(a.node)}},e.prototype.preview=c(function(){var a=this;this.currentContent.render().then(function(b){var c=document.createElement("div"),d=document.createDocumentFragment();c.innerHTML=b,Array.from(c.childNodes).forEach(function(a){d.appendChild(a)}),a.nodeContentPreview.innerHTML="",a.nodeContentPreview.appendChild(d)}).catch(function(a){console.error(a)})},500),e.prototype.save=c(function(){var a=this;return this.nodeErrors.innerHTML="",this.article.save().then(function(){console.log("Last saved at "+(new Date).toISOString()),/\/0$/.test(location.href)&&location.pushState({},document.title,location.href.replace(/0$/,article.id)),a.nodeSave.textContent="保存済み",setTimeout(function(){a.nodeSave.textContent="保存"},2e3)}).catch(function(b){var c;return b instanceof i?void a.nodeErrors.appendChild(b.messages.reduce(function(a,b){var c=d("articleEditor_errors_error");return c.textContent=b,a.appendChild(c),a},document.createDocumentFragment())):(c=d("articleEditor_errors_error"),c.textContent=b.message,void a.nodeErrors.appendChild(c))})},2e3),window.addEventListener("popstate",function(a){a.originalEvent.state&&(location.href=location.href.replace(/\d+$/,article.id))}),e.prototype.attachArticle=function(a){this.article=a,this.nodePathInput.value=a.path,a.contents.forEach(function(a){this.createContent(a)},this),this.switchContent(this.langTabItems[0],this.langTabItems[0].content)},f.prototype.select=function(){this.isSelected||(this.isSelected=!0,this.node.classList.add("articleEditor_langTab_item-selected"),this.nodeLang.contentEditable=!0)},f.prototype.unselect=function(){this.isSelected&&(this.isSelected=!1,this.node.classList.remove("articleEditor_langTab_item-selected"),this.nodeLang.contentEditable=!1,EventRouter.emit("changeLangTabItemLang",[this,this.content]))},g.fromJson=function(a){var b=new g;return("string"==typeof a||a instanceof String)&&(a=JSON.parse(a)),b.id=a.id,b.path=a.path,b.contents=a.contents.reduce(function(a,b){return a.push(h.fromJson(b)),a},[]),b},g.prototype.isValid=function(){return this.errors=[],this.path||this.errors.push("Article#pathは必須"),this.path.startsWith("/")||this.errors.push("Article#pathはルート/から始まらねばならない: "+this.path),0===this.contents.length&&this.errors.push("Article#contentsは必須"),this.errors=this.errors.concat(this.contents.reduce(function(a,b){return b.isValid()||(a=a.concat(b.errors)),a},[])),0===this.errors.length},g.prototype.toJson=function(){return JSON.stringify({id:this.id,path:this.path,contents:this.contents.map(function(a){return{lang:a.lang,content:a.content}})})},g.prototype.save=function(){var a=this,b=new XMLHttpRequest;return b.open("PUT","/admin/articles/update/"+this.id),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),new Promise(function(c,d){return a.isValid()?(b.onload=function(){console.log(b.response),c()},b.onerror=function(){return 422===b.status?d(new i([JSON.parse(b.statusText).errors])):void d(new j(b))},void b.send("article="+encodeURIComponent(a.toJson()))):d(new i(a.errors))})},g.prototype.findByLang=function(a){return this.contents.filter(function(b){return b.lang===a})[0]},h.fromJson=function(a){var b=new h;return("string"==typeof a||a instanceof String)&&(a=JSON.parse(a)),b.lang=a.lang,b.content=a.content,b},h.prototype.isValid=function(){return this.errors=[],this.lang||this.errors.push("ArticleContent#langは必須"),/^[a-z]{2,3}$/.test(this.lang)||this.errors.push("ArticleContent#langはISO 3166-1形式でなければならない: "+this.lang),0===this.errors.length},h.prototype.render=function(){var a=new XMLHttpRequest;return a.open("GET","/admin/articles/preview?content="+encodeURIComponent(this.content)),new Promise(function(b,c){a.onload=function(){b(a.responseText)},a.onerror=function(){c(new j(a))},a.send()})},i.prototype=Object.create(Error.prototype,{constructor:{value:i}}),j.prototype=Object.create(Error.prototype,{constructor:{value:j}}),a.ArticleEditor=e,a.Article=g,a.ArticleContent=h}((this||0).self||global);
//# sourceMappingURL=article_editor.min.js.map