!function(t){"use strict";function e(e){return t.setImmediate?t.setImmediate(e):t.requestAnimationFrame?t.requestAnimationFrame(e):setTimeout(e,0)}function n(t,n){var r=!1,o=!1;return n||(r=!0),(!n||0>=n)&&(n=1e3/30),function(){o||(o=!0,t.apply(this,arguments),r?e(function(){o=!1}):setTimeout(function(){o=!1},n))}}function r(t,e){var n=Date.now();return(!e||0>=e)&&(e=1e3/30),function(){var r=Date.now();n+e>r||(n=r,t.apply(null,arguments))}}Array.from||(Array.from=function(t){return[].slice.call(t)}),Date.now||(Date.now=function(){(new Date).getTime()}),String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(t,e){return e=e||0,this.lastIndexOf(t,e)===e}}),t.requestAnimationFrame||(t.requestanimationframe=t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.msRequestAnimationFrame||t.oRequestAnimationFrame||t.khtmlRequestAnimationFrame),t.throttle=n,t.debounce=r}((this||0).self||global),function(t){"use strict";function e(t){return document.importNode(document.getElementById(t).content,!0).firstElementChild}function n(t,e){var r=this;return n.instance?n.instance:(n.instance=this,e=e||new o,this.article=null,this.currentContent=null,this.langTabItems=[],this.node=t,this.nodePathInput=t.querySelector(".articleEditor_path_input"),this.nodeLangTab=t.querySelector(".articleEditor_langTab"),this.nodeLangTabPlus=t.querySelector(".articleEditor_langTab_plus"),this.nodeContentInput=t.querySelector(".articleEditor_content_input"),this.nodeContentPreview=t.querySelector(".articleEditor_content_preview"),this.nodeErrors=t.querySelector(".articleEditor_errors"),this.nodeSave=t.querySelector(".articleEditor_save"),this.nodeRemove=t.querySelector(".articleEditor_remove"),c.on("selectLangTabItem",function(t,e){r.switchContent(t,e)}),c.on("changeLangTabItemLang",function(t,e){e.lang=t.nodeLang.textContent}),c.on("removeLangTabItem",function(t,e){r.removeContent(t,e)}),this.nodePathInput.addEventListener("keyup",function(){r.article.path=r.nodePathInput.value}),this.nodeLangTabPlus.addEventListener("click",function(){r.createContent()}),this.nodeSave.addEventListener("click",function(){r.save()}),this.nodeRemove.addEventListener("click",function(){r.destroy()}),void this.attachArticle(e))}function r(t){var n=this;this.content=t,this.isSelected=!1,this.node=e("articleEditor_langTab_item"),this.nodeLang=this.node.querySelector(".articleEditor_langTab_item_lang"),this.nodeRemove=this.node.querySelector(".articleEditor_langTab_item_remove"),this.nodeLang.textContent=t.lang||"-",this.nodeLang.addEventListener("click",function(){c.emit("selectLangTabItem",[n,n.content])}),this.nodeLang.addEventListener("keyup",function(){c.emit("changeLangTabItemLang",[n,t])}),this.nodeRemove.addEventListener("click",function(){c.emit("removeLangTabItem",[n,t])})}function o(){var t;this.id=0,this.path="",this.contents=[],this.errors=[],t=new i,t.lang="ja",this.contents.push(t),t=new i,t.lang="en",this.contents.push(t)}function i(){this.lang="",this.content="---\ntitle: 題\ndescription: 説明\n---\n{{ title }}\n==\n本文。",this.errors=[]}function s(t){this.name=s.name,this.messages=t,this.stack=Error().stack}function a(t){var e;this.name=a.name,e=(t.responseText||this.name)+" HTTP status: "+t.status,this.message=e,this.stack=Error().stack}var c={listeners:{},emit:function(t,e,n){e=e||[],n=n||null,this.listeners[t].forEach(function(t){t.apply(n,e)})},on:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}};n.instance=null,n.prototype.run=function(){var t=this,e="";requestAnimationFrame(function n(){t.currentContent.content=t.nodeContentInput.value,e!==t.currentContent.content&&t.preview(function(n){return n?t.showError(n):void(e=t.currentContent.content)}),requestAnimationFrame(n)})},n.prototype.switchContent=function(t,e){this.currentContent=e,this.langTabItems.forEach(function(t){t.unselect()}),t.select(),this.nodeContentInput.value=this.currentContent.content,this.preview()},n.prototype.createContent=function(t){var e;t||(t=new i,this.article.contents.push(t)),e=new r(t),this.langTabItems.push(e),this.nodeLangTab.insertBefore(e.node,this.nodeLangTabPlus),this.switchContent(e,t)},n.prototype.removeContent=function(t,e){var n,r=0,o=0;if(window.confirm("ArticleContent "+e.lang+" を削除するか?")){for(r=0,o=this.article.contents.length;o>r;++r)if(e===this.article.contents[r]){this.article.contents.splice(r,1);break}for(r=0,o=this.langTabItems.length;o>r;++r)if(t===this.langTabItems[r]){this.langTabItems.splice(r,1);break}t.node.classList.contains("articleEditor_langTab_item-selected")&&(0===this.langTabItems.length?(this.createContent(),n=this.langTabItems[0]):n=0===r?this.langTabItems[0]:this.langTabItems[r-1],this.switchContent(n,n.content)),this.nodeLangTab.removeChild(t.node)}},n.prototype.preview=throttle(function(t){var e=this;this.currentContent.render().then(function(n){var r=document.createElement("div"),o=document.createDocumentFragment();r.innerHTML=n,Array.from(r.childNodes).forEach(function(t){o.appendChild(t)}),e.nodeContentPreview.innerHTML="",e.nodeContentPreview.appendChild(o),t&&t()})["catch"](function(e){t&&t(e)})},500),n.prototype.save=throttle(function(){var t=this;return this.nodeErrors.innerHTML="",this.article.save().then(function(){console.log("Last saved at "+(new Date).toISOString()),/\/0$/.test(location.href)&&history.pushState({},document.title,location.href.replace(/0$/,t.article.id)),t.nodeSave.textContent="保存済み",setTimeout(function(){t.nodeSave.textContent="保存"},2e3)})["catch"](function(e){t.showError(e)})},2e3),window.addEventListener("popstate",function(t){t.state&&history.bask()}),n.prototype.destroy=function(){var t=this;window.confirm("Articleを削除するか?")&&this.article.destroy().then(function(){location.href="/admin/"})["catch"](function(e){t.showError(e)})},n.prototype.showError=function(t){var n;return t instanceof s?void this.nodeErrors.appendChild(t.messages.reduce(function(t,n){var r=e("articleEditor_errors_error");return r.textContent=n,t.appendChild(r),t},document.createDocumentFragment())):(n=e("articleEditor_errors_error"),n.textContent=t.message,void this.nodeErrors.appendChild(n))},n.prototype.attachArticle=function(t){this.article=t,this.nodePathInput.value=t.path,t.contents.forEach(function(t){this.createContent(t)},this),this.switchContent(this.langTabItems[0],this.langTabItems[0].content)},r.prototype.select=function(){this.isSelected||(this.isSelected=!0,this.node.classList.add("articleEditor_langTab_item-selected"),this.nodeLang.contentEditable=!0)},r.prototype.unselect=function(){this.isSelected&&(this.isSelected=!1,this.node.classList.remove("articleEditor_langTab_item-selected"),this.nodeLang.contentEditable=!1,c.emit("changeLangTabItemLang",[this,this.content]))},o.fromJson=function(t){var e=new o;return("string"==typeof t||t instanceof String)&&(t=JSON.parse(t)),e.id=t.id,e.path=t.path,e.contents=t.contents.reduce(function(t,e){return t.push(i.fromJson(e)),t},[]),e},o.prototype.isValid=function(){return this.errors=[],this.path||this.errors.push("Article#pathは必須"),this.path.startsWith("/")||this.errors.push("Article#pathはルート/から始まらねばならない: "+this.path),0===this.contents.length&&this.errors.push("Article#contentsは必須"),this.errors=this.errors.concat(this.contents.reduce(function(t,e){return e.isValid()||(t=t.concat(e.errors)),t},[])),0===this.errors.length},o.prototype.toJson=function(){return JSON.stringify({id:this.id,path:this.path,contents:this.contents.map(function(t){return{lang:t.lang,content:t.content}})})},o.prototype.save=function(){var t=this,e=new XMLHttpRequest;return e.open("PUT","/admin/articles/update/"+this.id),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),new Promise(function(n,r){return t.isValid()?(e.onload=function(){t.id=JSON.parse(e.responseText).id,n()},e.onerror=function(){return 422===e.status?r(new s([JSON.parse(e.statusText).errors])):void r(new a(e))},void e.send("article="+encodeURIComponent(t.toJson()))):r(new s(t.errors))})},o.prototype.destroy=function(){var t=new XMLHttpRequest;return t.open("DELETE","/admin/articles/destroy/"+this.id),new Promise(function(e,n){t.onload=function(){e()},t.onerror=function(){n(new a(t))},t.send()})},o.prototype.findByLang=function(t){return this.contents.filter(function(e){return e.lang===t})[0]},i.fromJson=function(t){var e=new i;return("string"==typeof t||t instanceof String)&&(t=JSON.parse(t)),e.lang=t.lang,e.content=t.content,e},i.prototype.isValid=function(){return this.errors=[],this.lang||this.errors.push("ArticleContent#langは必須"),/^[a-z]{2,3}$/.test(this.lang)||this.errors.push("ArticleContent#langはISO 3166-1形式でなければならない: "+this.lang),0===this.errors.length},i.prototype.render=function(){var t=this,e=new XMLHttpRequest;return e.open("POST","/admin/articles/preview"),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),new Promise(function(n,r){e.onload=function(){n(e.responseText)},e.onerror=function(){r(new a(e))},e.send("content="+encodeURIComponent(t.content))})},s.prototype=Object.create(Error.prototype,{constructor:{value:s}}),a.prototype=Object.create(Error.prototype,{constructor:{value:a}}),t.ArticleEditor=n,t.Article=o,t.ArticleContent=i}((this||0).self||global);
//# sourceMappingURL=article_editor.min.js.map