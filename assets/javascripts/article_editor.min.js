!function(a){"use strict";function b(b){return a.setImmediate?a.setImmediate(b):a.requestAnimationFrame?a.requestAnimationFrame(b):setTimeout(b,0)}function c(a,c){var d=!1,e=!1;return c||(d=!0),(!c||0>=c)&&(c=1e3/30),function(){e||(e=!0,a.apply(this,arguments),d?b(function(){e=!1}):setTimeout(function(){e=!1},c))}}function d(a,b){var c=Date.now();return(!b||0>=b)&&(b=1e3/30),function(){var d=Date.now();c+b>d||(c=d,a.apply(null,arguments))}}Array.from||(Array.from=function(a){return[].slice.call(a)}),Date.now||(Date.now=function(){(new Date).getTime()}),String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(a,b){return b=b||0,this.lastIndexOf(a,b)===b}}),a.requestAnimationFrame||(a.requestanimationframe=a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.msRequestAnimationFrame||a.oRequestAnimationFrame||a.khtmlRequestAnimationFrame),a.throttle=c,a.debounce=d}((this||0).self||global),function(a){"use strict";function b(a){return document.importNode(document.getElementById(a).content,!0).firstElementChild}function c(a,b){var d=this;return c.instance?c.instance:(c.instance=this,b=b||new e,this.article=null,this.currentContent=null,this.langTabItems=[],this.node=a,this.nodePathInput=a.querySelector(".articleEditor_path_input"),this.nodeLangTab=a.querySelector(".articleEditor_langTab"),this.nodeLangTabPlus=a.querySelector(".articleEditor_langTab_plus"),this.nodeContentInput=a.querySelector(".articleEditor_content_input"),this.nodeContentPreview=a.querySelector(".articleEditor_content_preview"),this.nodeErrors=a.querySelector(".articleEditor_errors"),this.nodeSave=a.querySelector(".articleEditor_save"),this.nodeRemove=a.querySelector(".articleEditor_remove"),i.on("selectLangTabItem",function(a,b){d.switchContent(a,b)}),i.on("changeLangTabItemLang",function(a,b){b.lang=a.nodeLang.textContent}),i.on("removeLangTabItem",function(a,b){d.removeContent(a,b)}),this.nodePathInput.addEventListener("keyup",function(){d.article.path=d.nodePathInput.value}),this.nodeLangTabPlus.addEventListener("click",function(){d.createContent()}),this.nodeSave.addEventListener("click",function(){d.save()}),this.nodeRemove.addEventListener("click",function(){d.destroy()}),void this.attachArticle(b))}function d(a){var c=this;this.content=a,this.isSelected=!1,this.node=b("articleEditor_langTab_item"),this.nodeLang=this.node.querySelector(".articleEditor_langTab_item_lang"),this.nodeRemove=this.node.querySelector(".articleEditor_langTab_item_remove"),this.nodeLang.textContent=a.lang||"-",this.nodeLang.addEventListener("click",function(){i.emit("selectLangTabItem",[c,c.content])}),this.nodeLang.addEventListener("keyup",function(){i.emit("changeLangTabItemLang",[c,a])}),this.nodeRemove.addEventListener("click",function(){i.emit("removeLangTabItem",[c,a])})}function e(){var a;this.id=0,this.path="",this.contents=[],this.errors=[],a=new f,a.lang="ja",this.contents.push(a),a=new f,a.lang="en",this.contents.push(a)}function f(){this.lang="",this.content="---\ntitle: 題\ndescription: 説明\n---\n{{ title }}\n==\n本文。",this.errors=[]}function g(a){this.name=g.name,this.messages=a,this.stack=Error().stack}function h(a){var b;this.name=h.name,b=(a.responseText||this.name)+" HTTP status: "+a.status,this.message=b,this.stack=Error().stack}var i={listeners:{},emit:function(a,b,c){b=b||[],c=c||null,this.listeners[a].forEach(function(a){a.apply(c,b)})},on:function(a,b){this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].push(b)}};c.instance=null,c.prototype.run=function(){var a=this,b="";requestAnimationFrame(function c(){a.currentContent.content=a.nodeContentInput.value,b!==a.currentContent.content&&a.preview(function(c){return c?a.showError(c):void(b=a.currentContent.content)}),requestAnimationFrame(c)})},c.prototype.switchContent=function(a,b){this.currentContent=b,this.langTabItems.forEach(function(a){a.unselect()}),a.select(),this.nodeContentInput.value=this.currentContent.content,this.preview()},c.prototype.createContent=function(a){var b;a||(a=new f,this.article.contents.push(a)),b=new d(a),this.langTabItems.push(b),this.nodeLangTab.insertBefore(b.node,this.nodeLangTabPlus),this.switchContent(b,a)},c.prototype.removeContent=function(a,b){var c,d=0,e=0;if(window.confirm("ArticleContent "+b.lang+" を削除するか?")){for(d=0,e=this.article.contents.length;e>d;++d)if(b===this.article.contents[d]){this.article.contents.splice(d,1);break}for(d=0,e=this.langTabItems.length;e>d;++d)if(a===this.langTabItems[d]){this.langTabItems.splice(d,1);break}a.node.classList.contains("articleEditor_langTab_item-selected")&&(0===this.langTabItems.length?(this.createContent(),c=this.langTabItems[0]):c=0===d?this.langTabItems[0]:this.langTabItems[d-1],this.switchContent(c,c.content)),this.nodeLangTab.removeChild(a.node)}},c.prototype.preview=throttle(function(a){var b=this;this.currentContent.render().then(function(c){var d=document.createElement("div"),e=document.createDocumentFragment();d.innerHTML=c,Array.from(d.childNodes).forEach(function(a){e.appendChild(a)}),b.nodeContentPreview.innerHTML="",b.nodeContentPreview.appendChild(e),a&&a()}).catch(function(b){a&&a(b)})},500),c.prototype.save=throttle(function(){var a=this;return this.nodeErrors.innerHTML="",this.article.save().then(function(){console.log("Last saved at "+(new Date).toISOString()),/\/0$/.test(location.href)&&history.pushState({},document.title,location.href.replace(/0$/,a.article.id)),a.nodeSave.textContent="保存済み",setTimeout(function(){a.nodeSave.textContent="保存"},2e3)}).catch(function(b){a.showError(b)})},2e3),window.addEventListener("popstate",function(a){a.state&&history.bask()}),c.prototype.destroy=function(){var a=this;window.confirm("Articleを削除するか?")&&this.article.destroy().then(function(){location.href="/admin/"}).catch(function(b){a.showError(b)})},c.prototype.showError=function(a){var c;return a instanceof g?void this.nodeErrors.appendChild(a.messages.reduce(function(a,c){var d=b("articleEditor_errors_error");return d.textContent=c,a.appendChild(d),a},document.createDocumentFragment())):(c=b("articleEditor_errors_error"),c.textContent=a.message,void this.nodeErrors.appendChild(c))},c.prototype.attachArticle=function(a){this.article=a,this.nodePathInput.value=a.path,a.contents.forEach(function(a){this.createContent(a)},this),this.switchContent(this.langTabItems[0],this.langTabItems[0].content)},d.prototype.select=function(){this.isSelected||(this.isSelected=!0,this.node.classList.add("articleEditor_langTab_item-selected"),this.nodeLang.contentEditable=!0)},d.prototype.unselect=function(){this.isSelected&&(this.isSelected=!1,this.node.classList.remove("articleEditor_langTab_item-selected"),this.nodeLang.contentEditable=!1,i.emit("changeLangTabItemLang",[this,this.content]))},e.fromJson=function(a){var b=new e;return("string"==typeof a||a instanceof String)&&(a=JSON.parse(a)),b.id=a.id,b.path=a.path,b.contents=a.contents.reduce(function(a,b){return a.push(f.fromJson(b)),a},[]),b},e.prototype.isValid=function(){return this.errors=[],this.path||this.errors.push("Article#pathは必須"),this.path.startsWith("/")||this.errors.push("Article#pathはルート/から始まらねばならない: "+this.path),0===this.contents.length&&this.errors.push("Article#contentsは必須"),this.errors=this.errors.concat(this.contents.reduce(function(a,b){return b.isValid()||(a=a.concat(b.errors)),a},[])),0===this.errors.length},e.prototype.toJson=function(){return JSON.stringify({id:this.id,path:this.path,contents:this.contents.map(function(a){return{lang:a.lang,content:a.content}})})},e.prototype.save=function(){var a=this,b=new XMLHttpRequest;return b.open("PUT","/admin/articles/update/"+this.id),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),new Promise(function(c,d){return a.isValid()?(b.onload=function(){a.id=JSON.parse(b.responseText).id,c()},b.onerror=function(){return 422===b.status?d(new g([JSON.parse(b.statusText).errors])):void d(new h(b))},void b.send("article="+encodeURIComponent(a.toJson()))):d(new g(a.errors))})},e.prototype.destroy=function(){var a=new XMLHttpRequest;return a.open("DELETE","/admin/articles/destroy/"+this.id),new Promise(function(b,c){a.onload=function(){b()},a.onerror=function(){c(new h(a))},a.send()})},e.prototype.findByLang=function(a){return this.contents.filter(function(b){return b.lang===a})[0]},f.fromJson=function(a){var b=new f;return("string"==typeof a||a instanceof String)&&(a=JSON.parse(a)),b.lang=a.lang,b.content=a.content,b},f.prototype.isValid=function(){return this.errors=[],this.lang||this.errors.push("ArticleContent#langは必須"),/^[a-z]{2,3}$/.test(this.lang)||this.errors.push("ArticleContent#langはISO 3166-1形式でなければならない: "+this.lang),0===this.errors.length},f.prototype.render=function(){var a=new XMLHttpRequest;return a.open("GET","/admin/articles/preview?content="+encodeURIComponent(this.content)),new Promise(function(b,c){a.onload=function(){b(a.responseText)},a.onerror=function(){c(new h(a))},a.send()})},g.prototype=Object.create(Error.prototype,{constructor:{value:g}}),h.prototype=Object.create(Error.prototype,{constructor:{value:h}}),a.ArticleEditor=c,a.Article=e,a.ArticleContent=f}((this||0).self||global);
//# sourceMappingURL=article_editor.min.js.map