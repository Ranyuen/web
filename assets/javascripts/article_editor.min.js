!function(e){"use strict";function t(t){return e.setImmediate?e.setImmediate(t):e.requestAnimationFrame?e.requestAnimationFrame(t):setTimeout(t,0)}function n(e,n){var r=!1,i=!1;return n||(r=!0),(!n||n<=0)&&(n=1e3/30),function(){i||(i=!0,e.apply(this,arguments),r?t(function(){i=!1}):setTimeout(function(){i=!1},n))}}function r(e,t){var n=Date.now();return(!t||t<=0)&&(t=1e3/30),function(){var r=Date.now();n+t>r||(n=r,e.apply(null,arguments))}}Array.from||(Array.from=function(e){return[].slice.call(e)}),Date.now||(Date.now=function(){(new Date).getTime()}),String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(e,t){return t=t||0,this.lastIndexOf(e,t)===t}}),e.requestAnimationFrame||(e.requestanimationframe=e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.msRequestAnimationFrame||e.oRequestAnimationFrame||e.khtmlRequestAnimationFrame),e.throttle=n,e.debounce=r}((this||0).self||global),function(e){"use strict";function t(e){return document.importNode(document.getElementById(e).content,!0).firstElementChild}function n(e,t){var r=this;if(n.instance)return n.instance;n.instance=this,t=t||new i,this.article=null,this.currentContent=null,this.langTabItems=[],this.node=e,this.nodePathInput=e.querySelector(".articleEditor_path_input"),this.nodeLangTab=e.querySelector(".articleEditor_langTab"),this.nodeLangTabPlus=e.querySelector(".articleEditor_langTab_plus"),this.nodeContentInput=e.querySelector(".articleEditor_content_input"),this.nodeContentPreview=e.querySelector(".articleEditor_content_preview"),this.nodeErrors=e.querySelector(".articleEditor_errors"),this.nodeSave=e.querySelector(".articleEditor_save"),this.nodeRemove=e.querySelector(".articleEditor_remove"),c.on("selectLangTabItem",function(e,t){r.switchContent(e,t)}),c.on("changeLangTabItemLang",function(e,t){t.lang=e.nodeLang.textContent}),c.on("removeLangTabItem",function(e,t){r.removeContent(e,t)}),this.nodePathInput.addEventListener("keyup",function(){r.article.path=r.nodePathInput.value}),this.nodeLangTabPlus.addEventListener("click",function(){r.createContent()}),this.nodeSave.addEventListener("click",function(){r.save()}),this.nodeRemove.addEventListener("click",function(){r.destroy()}),this.attachArticle(t)}function r(e){var n=this;this.content=e,this.isSelected=!1,this.node=t("articleEditor_langTab_item"),this.nodeLang=this.node.querySelector(".articleEditor_langTab_item_lang"),this.nodeRemove=this.node.querySelector(".articleEditor_langTab_item_remove"),this.nodeLang.textContent=e.lang||"-",this.nodeLang.addEventListener("click",function(){c.emit("selectLangTabItem",[n,n.content])}),this.nodeLang.addEventListener("keyup",function(){c.emit("changeLangTabItemLang",[n,e])}),this.nodeRemove.addEventListener("click",function(){c.emit("removeLangTabItem",[n,e])})}function i(){var e;this.id=0,this.path="",this.contents=[],this.errors=[],e=new o,e.lang="ja",this.contents.push(e),e=new o,e.lang="en",this.contents.push(e)}function o(){this.lang="",this.content="---\ntitle: 題\ndescription: 説明\n---\n{{ title }}\n==\n本文。",this.errors=[]}function s(e){this.name=s.name,this.messages=e,this.stack=Error().stack}function a(e){var t;this.name=a.name,t=(e.responseText||this.name)+" HTTP status: "+e.status,this.message=t,this.stack=Error().stack}var c={listeners:{},emit:function(e,t,n){t=t||[],n=n||null,this.listeners[e].forEach(function(e){e.apply(n,t)})},on:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}};n.instance=null,n.prototype.run=function(){var e=this,t="";requestAnimationFrame(function n(){e.currentContent.content=e.nodeContentInput.value,t!==e.currentContent.content&&e.preview(function(n){if(n)return e.showError(n);t=e.currentContent.content}),requestAnimationFrame(n)})},n.prototype.switchContent=function(e,t){this.currentContent=t,this.langTabItems.forEach(function(e){e.unselect()}),e.select(),this.nodeContentInput.value=this.currentContent.content,this.preview()},n.prototype.createContent=function(e){var t;e||(e=new o,this.article.contents.push(e)),t=new r(e),this.langTabItems.push(t),this.nodeLangTab.insertBefore(t.node,this.nodeLangTabPlus),this.switchContent(t,e)},n.prototype.removeContent=function(e,t){var n,r=0,i=0;if(window.confirm("ArticleContent "+t.lang+" を削除するか?")){for(r=0,i=this.article.contents.length;r<i;++r)if(t===this.article.contents[r]){this.article.contents.splice(r,1);break}for(r=0,i=this.langTabItems.length;r<i;++r)if(e===this.langTabItems[r]){this.langTabItems.splice(r,1);break}e.node.classList.contains("articleEditor_langTab_item-selected")&&(0===this.langTabItems.length?(this.createContent(),n=this.langTabItems[0]):n=0===r?this.langTabItems[0]:this.langTabItems[r-1],this.switchContent(n,n.content)),this.nodeLangTab.removeChild(e.node)}},n.prototype.preview=throttle(function(e){var t=this;this.currentContent.render().then(function(n){var r=document.createElement("div"),i=document.createDocumentFragment();r.innerHTML=n,Array.from(r.childNodes).forEach(function(e){i.appendChild(e)}),t.nodeContentPreview.innerHTML="",t.nodeContentPreview.appendChild(i),e&&e()}).catch(function(t){e&&e(t)})},500),n.prototype.save=throttle(function(){var e=this;return this.nodeErrors.innerHTML="",this.article.save().then(function(){console.log("Last saved at "+(new Date).toISOString()),/\/0$/.test(location.href)&&history.pushState({},document.title,location.href.replace(/0$/,e.article.id)),e.nodeSave.textContent="保存済み",setTimeout(function(){e.nodeSave.textContent="保存"},2e3)}).catch(function(t){e.showError(t)})},2e3),window.addEventListener("popstate",function(e){e.state&&history.bask()}),n.prototype.destroy=function(){var e=this;window.confirm("Articleを削除するか?")&&this.article.destroy().then(function(){location.href="/admin/"}).catch(function(t){e.showError(t)})},n.prototype.showError=function(e){var n;if(e instanceof s)return void this.nodeErrors.appendChild(e.messages.reduce(function(e,n){var r=t("articleEditor_errors_error");return r.textContent=n,e.appendChild(r),e},document.createDocumentFragment()));n=t("articleEditor_errors_error"),n.textContent=e.message,this.nodeErrors.appendChild(n)},n.prototype.attachArticle=function(e){this.article=e,this.nodePathInput.value=e.path,e.contents.forEach(function(e){this.createContent(e)},this),this.switchContent(this.langTabItems[0],this.langTabItems[0].content)},r.prototype.select=function(){this.isSelected||(this.isSelected=!0,this.node.classList.add("articleEditor_langTab_item-selected"),this.nodeLang.contentEditable=!0)},r.prototype.unselect=function(){this.isSelected&&(this.isSelected=!1,this.node.classList.remove("articleEditor_langTab_item-selected"),this.nodeLang.contentEditable=!1,c.emit("changeLangTabItemLang",[this,this.content]))},i.fromJson=function(e){var t=new i;return("string"==typeof e||e instanceof String)&&(e=JSON.parse(e)),t.id=e.id,t.path=e.path,t.contents=e.contents.reduce(function(e,t){return e.push(o.fromJson(t)),e},[]),t},i.prototype.isValid=function(){return this.errors=[],this.path||this.errors.push("Article#pathは必須"),this.path.startsWith("/")||this.errors.push("Article#pathはルート/から始まらねばならない: "+this.path),0===this.contents.length&&this.errors.push("Article#contentsは必須"),this.errors=this.errors.concat(this.contents.reduce(function(e,t){return t.isValid()||(e=e.concat(t.errors)),e},[])),0===this.errors.length},i.prototype.toJson=function(){return JSON.stringify({id:this.id,path:this.path,contents:this.contents.map(function(e){return{lang:e.lang,content:e.content}})})},i.prototype.save=function(){var e=this,t=new XMLHttpRequest;return t.open("PUT","/admin/articles/update/"+this.id),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),new Promise(function(n,r){if(!e.isValid())return r(new s(e.errors));t.onload=function(){e.id=JSON.parse(t.responseText).id,n()},t.onerror=function(){if(422===t.status)return r(new s([JSON.parse(t.statusText).errors]));r(new a(t))},t.send("article="+encodeURIComponent(e.toJson()))})},i.prototype.destroy=function(){var e=new XMLHttpRequest;return e.open("DELETE","/admin/articles/destroy/"+this.id),new Promise(function(t,n){e.onload=function(){t()},e.onerror=function(){n(new a(e))},e.send()})},i.prototype.findByLang=function(e){return this.contents.filter(function(t){return t.lang===e})[0]},o.fromJson=function(e){var t=new o;return("string"==typeof e||e instanceof String)&&(e=JSON.parse(e)),t.lang=e.lang,t.content=e.content,t},o.prototype.isValid=function(){return this.errors=[],this.lang||this.errors.push("ArticleContent#langは必須"),/^[a-z]{2,3}$/.test(this.lang)||this.errors.push("ArticleContent#langはISO 3166-1形式でなければならない: "+this.lang),0===this.errors.length},o.prototype.render=function(){var e=this,t=new XMLHttpRequest;return t.open("POST","/admin/articles/preview"),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),new Promise(function(n,r){t.onload=function(){n(t.responseText)},t.onerror=function(){r(new a(t))},t.send("content="+encodeURIComponent(e.content))})},s.prototype=Object.create(Error.prototype,{constructor:{value:s}}),a.prototype=Object.create(Error.prototype,{constructor:{value:a}}),e.ArticleEditor=n,e.Article=i,e.ArticleContent=o}((this||0).self||global);
//# sourceMappingURL=article_editor.min.js.map